<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #f0f4f8;
            --text-color: #1a202c;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --accent-color: #3182ce;
            --hover-bg: #f7fafc;
            --correct-bg: #c6f6d5;
            --correct-text: #22543d;
            --wrong-bg: #fed7d7;
            --wrong-text: #742a2a;
            --exp-bg: #fffaf0;
            --exp-border: #ed8936;
        }

        body.dark-mode {
            --bg-color: #1a202c;
            --text-color: #e2e8f0;
            --card-bg: #2d3748;
            --card-border: #4a5568;
            --accent-color: #63b3ed;
            --hover-bg: #4a5568;
            --correct-bg: #2f855a;
            --correct-text: #ffffff;
            --wrong-bg: #9b2c2c;
            --wrong-text: #ffffff;
            --exp-bg: #2c333a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.5;
            font-size: 0.95rem; /* Global text size reduction */
        }

        /* --- LAYOUT UTILS --- */
        .hidden-input { display: none; }

        .button-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--card-border);
        }

        h1 { margin: 0; font-size: 1.6rem; display: flex; align-items: center; gap: 12px; }

        .theme-btn {
            background: none;
            border: 2px solid var(--card-border);
            color: var(--text-color);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .theme-btn:hover { background-color: var(--hover-bg); }

        .main-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid var(--card-border);
        }

        .upload-box {
            text-align: center;
            padding: 30px;
            background: var(--hover-bg);
            border: 2px dashed var(--card-border);
            border-radius: 12px;
            margin-bottom: 30px;
        }

        /* --- CHOOSE FILE BUTTON --- */
        .button-sketch {
            text-align: center;
            transition: 0.3s ease-in-out;
            cursor: pointer;
            background-color: transparent;
            filter: url(#handDrawnNoise);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            font-family: "Courier New", monospace;
            font-size: 0.95rem; /* Reduced size */
            font-weight: bold;
            color: var(--text-color);
            padding: 0.6em 1.2em;
            border-width: 0px;
            border-radius: 2rem;
            box-shadow: #33333366 3px 3px 0 1px;
            animation: idle 1s infinite ease-in-out;
            position: relative;
        }

        .highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            fill: transparent;
            stroke: rgba(255, 225, 0, 0.5);
            stroke-width: 3;
            stroke-linecap: round;
            pointer-events: none;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            transition: stroke-dashoffset 0.5s ease-in-out;
            z-index: 0;
        }

        .button-cosm {
            fill: #33333366;
            transition: 0.3s ease-out;
            scale: 0.4;
            position: absolute;
            top: 50%;
            left: 0;
            translate: calc(-100% + 5px) -50%;
        }

        .button-sketch:hover { font-weight: bold; border-width: 0px; border-radius: 2rem; rotate: -2.5deg; animation: hover 2.5s infinite ease-in-out; }
        .button-sketch:hover .highlight { stroke-dashoffset: 0; }
        .button-sketch:active .highlight { stroke-dashoffset: 1000; animation: highlight 5s infinite, col 0.5s forwards; stroke: #bc4e2666; }
        .button-sketch:hover .button-cosm { rotate: -15deg; translate: calc(-100% + 2px) -50%; }
        .button-sketch:active .button-cosm { fill: #333333f1; rotate: -135deg; translate: calc(-100% + 30px) -50%; animation: none; }
        .button-sketch:active { font-weight: bold; border-width: 0px; border-radius: 2rem; box-shadow: inset #333333f1 4px 4px 0 1px; rotate: -2.5deg; animation: active 1s infinite ease-in-out; }

        .label-text { z-index: 1; position: relative; }

        /* --- GENERATE BUTTON --- */
        #gen-btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            font-size: 0.95rem; /* Reduced size */
            font-weight: 600;
            color: #1f2937;
            background-color: #f9fafb;
            border: 2px solid #f9fafb;
            border-radius: 9999px;
            box-shadow: 0 8px 12px -3px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
            overflow: hidden;
            cursor: pointer;
            transition: color 0.3s;
        }
        #gen-btn:hover { color: #f9fafb; }
        #gen-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        #gen-btn::before { content: ''; position: absolute; width: 100%; aspect-ratio: 1/1; left: -100%; background-color: #10b981; border-radius: 50%; z-index: -10; transition: all 0.7s; }
        #gen-btn:hover::before { left: 0; transform: scale(1.5); }
        #gen-btn svg { width: 1.3rem; height: 1.3rem; padding: 0.2rem; border-radius: 50%; border: 1px solid #374151; transform: rotate(45deg); transition: all 0.3s linear; fill: #1f2937; }
        #gen-btn:hover svg { transform: rotate(90deg); background-color: #f9fafb; border: none; }

        /* --- KEYFRAMES --- */
        @keyframes idle { 0% { filter: url(#handDrawnNoise); } 50% { rotate: 2.5deg; filter: url(#handDrawnNoise2); } 100% { filter: url(#handDrawnNoise); } }
        @keyframes hover { 0% { rotate: 0deg; filter: url(#handDrawnNoise); translate: 0 0px; } 25% { rotate: -1deg; filter: url(#handDrawnNoise2); translate: 0 -2px; } 50% { rotate: 0deg; filter: url(#handDrawnNoise); translate: 0 2px; } 75% { rotate: -1deg; filter: url(#handDrawnNoise2); translate: 0 -2px; } 100% { rotate: 0deg; filter: url(#handDrawnNoise); translate: 0 0px; } }
        @keyframes active { 0% { filter: url(#handDrawnNoiset); translate: 0 -1px; } 25% { rotate: -3deg; } 50% { filter: url(#handDrawnNoiset2); translate: 0 1px; } 66% { rotate: 1.5deg; } 100% { filter: url(#handDrawnNoiset); translate: 0 -1px; } }
        @keyframes highlight { 0% { stroke-dashoffset: 0; } 25% { stroke-dashoffset: 1000; } 50% { stroke-dashoffset: 1000; } 100% { stroke-dashoffset: 0; } }
        @keyframes col { 0% { stroke: rgba(255, 225, 0, 0.5); } 100% { stroke: #1c98eb66; } }

        /* --- QUIZ UI TEXT SIZES --- */
        .question-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        /* Question Text Size */
        .question-card h3 {
            margin-top: 0;
            font-size: 1.1rem; /* Smaller than before (was default h3) */
            line-height: 1.4;
        }

        /* Option Text Size */
        .option {
            display: block;
            position: relative;
            padding: 10px 10px 10px 40px; /* Reduced padding */
            margin: 8px 0;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.95rem; /* Smaller options */
        }
        .option:hover { background: var(--hover-bg); }
        .option input { position: absolute; left: 12px; top: 13px; transform: scale(1.2); }

        .correct { background: var(--correct-bg) !important; border-color: var(--correct-bg) !important; color: var(--correct-text); }
        .wrong { background: var(--wrong-bg) !important; border-color: var(--wrong-bg) !important; color: var(--wrong-text); }

        /* Explanation Text Size */
        .explanation-box {
            margin-top: 15px;
            padding: 12px;
            background: var(--exp-bg);
            border-left: 4px solid var(--exp-border);
            border-radius: 4px;
            display: none;
            font-size: 0.9rem; /* Smaller explanation */
        }

        #score-panel { display: none; text-align: center; padding: 25px; margin-top: 30px; border-radius: 12px; background: var(--hover-bg); border: 2px solid var(--accent-color); }
        #submit-btn { display: none; width: 100%; padding: 15px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

<div class="header">
    <h1><i class="fas fa-graduation-cap"></i> Quiz Generator</h1>
    <button class="theme-btn" onclick="toggleTheme()" id="theme-toggle">
        <i class="fas fa-moon"></i> Dark Mode
    </button>
</div>

<div class="main-container">
    <div class="upload-box">
        <i class="fas fa-file-pdf fa-3x" style="color: var(--accent-color); margin-bottom: 20px;"></i>
        <input type="file" id="pdfFileInput" accept=".pdf" class="hidden-input" onchange="updateFileName()">

        <div class="button-row">
            <label class="button-sketch" for="pdfFileInput">
                <span class="label-text" id="fileLabelText">Choose PDF</span>
                <svg class="highlight" viewBox="0 0 200 60" preserveAspectRatio="none">
                    <rect x="5" y="5" width="190" height="50" rx="25" ry="25" fill="none" />
                </svg>
                <svg class="button-cosm" width="20" height="20" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="5" />
                </svg>
            </label>

            <button id="gen-btn" onclick="handleGeneration()">
                Generate
                <svg viewBox="0 0 16 19" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 18C7 18.5523 7.44772 19 8 19C8.55228 19 9 18.5523 9 18H7ZM8.70711 0.292893C8.31658 -0.0976311 7.68342 -0.0976311 7.29289 0.292893L0.928932 6.65685C0.538408 7.04738 0.538408 7.68054 0.928932 8.07107C1.31946 8.46159 1.95262 8.46159 2.34315 8.07107L8 2.41421L13.6569 8.07107C14.0474 8.46159 14.6805 8.46159 15.0711 8.07107C15.4616 7.68054 15.4616 7.04738 15.0711 6.65685L8.70711 0.292893ZM9 18L9 1H7L7 18H9Z"></path>
                </svg>
            </button>
        </div>

        <div id="fileNameDisplay" style="margin-top: 15px; font-size: 0.85rem; color: var(--accent-color); font-weight: bold;"></div>
    </div>

    <div id="quiz-display-area"></div>

    <button id="submit-btn" onclick="processResults()">Finish & Show Explanations</button>

    <div id="score-panel">
        <h2 id="final-score-text"></h2>
    </div>
</div>

<svg style="display: none;">
    <defs>
        <filter id="handDrawnNoise">
            <feTurbulence baseFrequency="0.02" numOctaves="3" result="noise" type="fractalNoise"/>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" />
        </filter>
        <filter id="handDrawnNoise2">
            <feTurbulence baseFrequency="0.02" numOctaves="3" result="noise" type="fractalNoise" seed="2"/>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
        </filter>
        <filter id="handDrawnNoiset">
            <feTurbulence baseFrequency="0.8" numOctaves="3" result="noise" type="fractalNoise"/>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
        </filter>
        <filter id="handDrawnNoiset2">
            <feTurbulence baseFrequency="0.8" numOctaves="3" result="noise" type="fractalNoise" seed="2"/>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
        </filter>
    </defs>
</svg>

<script>
    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('theme-toggle');
        body.classList.toggle('dark-mode');
        if (body.classList.contains('dark-mode')) {
            btn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
        } else {
            btn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
        }
    }

    function updateFileName() {
        const input = document.getElementById('pdfFileInput');
        const display = document.getElementById('fileNameDisplay');
        if (input.files.length > 0) {
            display.innerText = "Selected: " + input.files[0].name;
            document.getElementById('fileLabelText').innerText = "Change File";
        } else {
            display.innerText = "";
            document.getElementById('fileLabelText').innerText = "Choose PDF";
        }
    }

    let activeQuizData = [];

    async function handleGeneration() {
        const fileInput = document.getElementById('pdfFileInput');
        const displayArea = document.getElementById('quiz-display-area');
        const genBtn = document.getElementById('gen-btn');

        if (!fileInput.files[0]) {
            alert("Please select your PDF first!");
            return;
        }

        genBtn.disabled = true;
        displayArea.innerHTML = `
            <div style='text-align:center; padding:50px;'>
                <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--accent-color);"></i><br><br>
                <b>Generating Questions...</b><br>
                <span style="font-size:0.9rem">This might take a moment.</span>
            </div>`;

        document.getElementById('score-panel').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'none';

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        try {
            const response = await fetch('/api/quiz/generate', { method: 'POST', body: formData });
            activeQuizData = await response.json();

            if (activeQuizData.length === 0) throw new Error("Empty response");
            buildQuizUI();
        } catch (error) {
            displayArea.innerHTML = `
                <div style='color:var(--wrong-text); text-align:center; padding: 20px;'>
                    <i class="fas fa-exclamation-triangle fa-2x"></i><br><br>
                    <b>Error!</b> Could not generate quiz.
                </div>`;
            genBtn.disabled = false;
        }
    }

    function buildQuizUI() {
        const area = document.getElementById('quiz-display-area');
        area.innerHTML = "";

        activeQuizData.forEach((item, qIdx) => {
            const choices = item.options || item.choices || [];
            const questionStr = item.question || "Untitled Question";

            let questionHtml = `
                <div class="question-card" id="q-container-${qIdx}">
                    <h3>${qIdx + 1}. ${questionStr}</h3>
                    <div class="options-group">
            `;

            choices.forEach((text, oIdx) => {
                questionHtml += `
                    <label class="option" id="label-${qIdx}-${oIdx}">
                        <input type="radio" name="q-group-${qIdx}" value="${oIdx}">
                        <span>${text}</span>
                    </label>
                `;
            });

            questionHtml += `
                    </div>
                    <div class="explanation-box" id="exp-text-${qIdx}">
                        <b style="color:#ed8936;"><i class="fas fa-lightbulb"></i> Explanation:</b><br>
                        ${item.explanation}
                    </div>
                </div>
            `;
            area.innerHTML += questionHtml;
        });

        document.getElementById('submit-btn').style.display = "block";
        document.getElementById('gen-btn').disabled = false;
    }

    function processResults() {
        let correctCount = 0;
        activeQuizData.forEach((item, qIdx) => {
            const selected = document.querySelector(`input[name="q-group-${qIdx}"]:checked`);
            const correctValue = item.correctAnswer;
            document.getElementById(`exp-text-${qIdx}`).style.display = "block";
            document.getElementById(`label-${qIdx}-${correctValue}`).classList.add('correct');
            if (selected) {
                const userChoice = parseInt(selected.value);
                if (userChoice === correctValue) correctCount++;
                else document.getElementById(`label-${qIdx}-${userChoice}`).classList.add('wrong');
            }
        });
        const scorePanel = document.getElementById('score-panel');
        scorePanel.style.display = "block";
        document.getElementById('final-score-text').innerHTML = `<i class="fas fa-trophy" style="color: #ecc94b;"></i> You scored ${correctCount} / ${activeQuizData.length}`;
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }
</script>

</body>
</html>